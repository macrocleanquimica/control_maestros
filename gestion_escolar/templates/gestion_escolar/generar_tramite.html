{% extends 'gestion_escolar/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ titulo }}</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.plantilla.id_for_label }}" class="form-label">{{ form.plantilla.label }}:</label>
                                    {{ form.plantilla }}
                                    {% if form.plantilla.errors %}
                                        <div class="text-danger">{{ form.plantilla.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6" id="motivo-tramite-wrapper">
                                <div class="mb-3">
                                    <label for="{{ form.motivo_tramite.id_for_label }}" class="form-label">{{ form.motivo_tramite.label }}:</label>
                                    {{ form.motivo_tramite }}
                                    {% if form.motivo_tramite.errors %}
                                        <div class="text-danger">{{ form.motivo_tramite.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div id="datos-titular-section">
                            <hr><h4 class="form-section-heading">Datos del Titular</h4><hr>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3" data-field-name="maestro_titular">
                                        <label for="id_maestro_titular" class="form-label">Maestro Titular:</label>
                                        <select name="maestro_titular" id="id_maestro_titular" class="form-control" style="width: 100%;"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="maestro_titular">
                                        <label for="{{ form.curp_titular_display.id_for_label }}" class="form-label">{{ form.curp_titular_display.label }}:</label>
                                        {{ form.curp_titular_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="maestro_titular">
                                        <label for="{{ form.rfc_titular_display.id_for_label }}" class="form-label">{{ form.rfc_titular_display.label }}:</label>
                                        {{ form.rfc_titular_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="maestro_titular">
                                        <label for="{{ form.clave_presupuestal_titular_display.id_for_label }}" class="form-label">{{ form.clave_presupuestal_titular_display.label }}:</label>
                                        {{ form.clave_presupuestal_titular_display }}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="maestro_titular">
                                        <label for="{{ form.categoria_titular_display.id_for_label }}" class="form-label">{{ form.categoria_titular_display.label }}:</label>
                                        {{ form.categoria_titular_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="maestro_titular">
                                        <label for="{{ form.funcion_titular_display.id_for_label }}" class="form-label">{{ form.funcion_titular_display.label }}:</label>
                                        {{ form.funcion_titular_display }}
                                    </div>
                                </div>
                            </div>
                            <!-- FECHAS DEL TITULAR MOVIDAS AQUÍ -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" data-field-name="fecha_efecto1">
                                        <label for="{{ form.fecha_efecto1.id_for_label }}" class="form-label">Fecha Inicial Titular:</label>
                                        {{ form.fecha_efecto1 }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3" data-field-name="fecha_efecto2">
                                        <label for="{{ form.fecha_efecto2.id_for_label }}" class="form-label">Fecha Final Titular:</label>
                                        {{ form.fecha_efecto2 }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="datos-interino-section">
                            <hr><h4 class="form-section-heading">Datos del Interino</h4><hr>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3" data-field-name="maestro_interino">
                                        <label for="id_maestro_interino" class="form-label">Maestro Interino:</label>
                                        <select name="maestro_interino" id="id_maestro_interino" class="form-control" style="width: 100%;"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="row" data-field-name="maestro_interino">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.no_prel_display.id_for_label }}" class="form-label">{{ form.no_prel_display.label }}:</label>
                                        {{ form.no_prel_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.folio_prel_display.id_for_label }}" class="form-label">{{ form.folio_prel_display.label }}:</label>
                                        {{ form.folio_prel_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.tipo_val_display.id_for_label }}" class="form-label">{{ form.tipo_val_display.label }}:</label>
                                        {{ form.tipo_val_display }}
                                    </div>
                                </div>
                            </div>
                            <div class="row" data-field-name="maestro_interino">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.curp_interino_display.id_for_label }}" class="form-label">{{ form.curp_interino_display.label }}:</label>
                                        {{ form.curp_interino_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.rfc_interino_display.id_for_label }}" class="form-label">{{ form.rfc_interino_display.label }}:</label>
                                        {{ form.rfc_interino_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.clave_presupuestal_interino_display.id_for_label }}" class="form-label">{{ form.clave_presupuestal_interino_display.label }}:</label>
                                        {{ form.clave_presupuestal_interino_display }}
                                    </div>
                                </div>
                            </div>
                            <div class="row" data-field-name="maestro_interino">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.funcion_interino_display.id_for_label }}" class="form-label">{{ form.funcion_interino_display.label }}:</label>
                                        {{ form.funcion_interino_display }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.tipo_movimiento_interino.id_for_label }}" class="form-label">{{ form.tipo_movimiento_interino.label }}:</label>
                                        {{ form.tipo_movimiento_interino }}
                                    </div>
                                </div>
                            </div>
                            <!-- FECHAS DEL INTERINO MOVIDAS AQUÍ -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" data-field-name="fecha_efecto3">
                                        <label for="{{ form.fecha_efecto3.id_for_label }}" class="form-label">Fecha Inicial Interino:</label>
                                        {{ form.fecha_efecto3 }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3" data-field-name="fecha_efecto4">
                                        <label for="{{ form.fecha_efecto4.id_for_label }}" class="form-label">Fecha Final Interino:</label>
                                        {{ form.fecha_efecto4 }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="otros-datos-section">
                            <hr><h4 class="form-section-heading">Otros Datos del Trámite</h4><hr>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="folio">
                                        <label for="{{ form.folio.id_for_label }}" class="form-label">{{ form.folio.label }}:</label>
                                        {{ form.folio }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="quincena_inicial">
                                        <label for="{{ form.quincena_inicial.id_for_label }}" class="form-label">{{ form.quincena_inicial.label }}:</label>
                                        {{ form.quincena_inicial }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3" data-field-name="quincena_final">
                                        <label for="{{ form.quincena_final.id_for_label }}" class="form-label">{{ form.quincena_final.label }}:</label>
                                        {{ form.quincena_final }}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3" data-field-name="observaciones">
                                <label for="{{ form.observaciones.id_for_label }}" class="form-label">{{ form.observaciones.label }}:</label>
                                {{ form.observaciones }}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">Generar Trámite</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Aplicar Select2 a los campos de selección
    $('#id_plantilla').select2({ placeholder: "Selecciona una plantilla", allowClear: true, width: '100%' });
    $('#id_motivo_tramite').select2({ placeholder: "Selecciona un motivo de trámite", allowClear: true, width: '100%' });

    // --- NUEVA LÓGICA DE VISIBILIDAD INICIAL ---
    const motivoTramiteWrapper = $('#motivo-tramite-wrapper');
    motivoTramiteWrapper.hide();

    function setupMaestroSelect2(selector, placeholder) {
        $(selector).select2({
            placeholder: placeholder,
            allowClear: true,
            width: '100%',
            ajax: {
                url: "{% url 'buscar_maestros_ajax' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term // 'term' es el texto que el usuario escribe
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            minimumInputLength: 2, // Empezar a buscar después de 2 caracteres
            language: {
                inputTooShort: function () {
                    return 'Ingresa nombres o apellidos';
                },
                noResults: function () {
                    return 'No se encontraron resultados';
                },
                searching: function () {
                    return 'Buscando...';
                }
            }
        });
    }

    setupMaestroSelect2('#id_maestro_titular', 'Busca y selecciona un maestro titular');
    setupMaestroSelect2('#id_maestro_interino', 'Busca y selecciona un maestro interino');

    // --- LÓGICA DE VISIBILIDAD DE CONTROLES ---
    const allManagedFields = ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino', 'fecha_efecto3', 'fecha_efecto4', 'folio', 'observaciones', 'quincena_inicial', 'quincena_final'];
    const allSections = ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'];

    const visibleFieldsConfig = {
        "REINGRESO": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino', 'fecha_efecto3', 'fecha_efecto4', 'folio', 'observaciones'], sections: ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'] },
        "FILIACION": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino', 'fecha_efecto3', 'fecha_efecto4', 'folio', 'observaciones'], sections: ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'] },
        "REINGRESO SIN PRELACION": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino', 'fecha_efecto3', 'fecha_efecto4', 'folio', 'observaciones'], sections: ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'] },
        "SOLICITUD DE ASIGNACION": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino', 'fecha_efecto3', 'fecha_efecto4', 'folio', 'observaciones'], sections: ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'] },
        "JUSTIFICACION DE PERFIL": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino', 'fecha_efecto3', 'fecha_efecto4', 'folio', 'observaciones'], sections: ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'] },
        "CONSTANCIAS": { fields: ['maestro_titular', 'folio', 'quincena_inicial', 'quincena_final'], sections: ['#datos-titular-section', '#otros-datos-section'] },
        "OFICIO DE REINCORPORACION": { fields: ['maestro_titular', 'folio', 'fecha_efecto1'], sections: ['#datos-titular-section', '#otros-datos-section'] },
        "CAMBIO DEL CENTRO DE TRABAJO": { fields: ['maestro_titular'], sections: ['#datos-titular-section'] },
        "CUADRO CAMBIOS CON FOLIO": { fields: ['maestro_titular', 'folio', 'fecha_efecto1'], sections: ['#datos-titular-section', '#otros-datos-section'] },
        "PROPUESTA DE MOVIMIENTO": { fields: ['maestro_titular', 'folio', 'fecha_efecto1'], sections: ['#datos-titular-section', '#otros-datos-section'] },
        "ALTA INICIAL": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'folio', 'observaciones'], sections: ['#datos-titular-section', '#otros-datos-section'] },
        "REPORTE DE VACANCIA": { fields: ['maestro_titular', 'fecha_efecto1', 'fecha_efecto2', 'maestro_interino'], sections: ['#datos-titular-section', '#datos-interino-section', '#otros-datos-section'] },
    };

    function updateFormVisibility() {
        const selectedPlantillaText = $('#id_plantilla option:selected').text().trim().toUpperCase();
        const config = visibleFieldsConfig[selectedPlantillaText];

        allManagedFields.forEach(fieldName => { $(`[data-field-name="${fieldName}"]`).hide(); });
        allSections.forEach(sectionId => { $(sectionId).hide(); });

        if (config) {
            config.fields.forEach(fieldName => { $(`[data-field-name="${fieldName}"]`).show(); });
            config.sections.forEach(sectionId => { $(sectionId).show(); });
        }
    }

    function getDateDiffInMonths(d1, d2) {
        var months = (d2.getFullYear() - d1.getFullYear()) * 12 - d1.getMonth() + d2.getMonth();
        if (d2.getDate() < d1.getDate()) { months--; }
        return months;
    }

    function calculateTipoMovimientoInterino() {
        var motivoTramiteText = $('#id_motivo_tramite option:selected').text().trim().toUpperCase();
        var fechaEfecto3Str = $('#id_fecha_efecto3').val();
        var fechaEfecto4Str = $('#id_fecha_efecto4').val();
        var resultadoAlta = "";

        switch (motivoTramiteText) {
            case "LIC. DE GRAVIDEZ": resultadoAlta = "ALTA INTERINA EN GRAVIDEZ"; break;
            case "LIC. POR PASAR A OTRO EMPLEO": resultadoAlta = "ALTA INICIAL POR PROMOCIÓN O ADMISIÓN"; break;
            default:
                if (!fechaEfecto3Str || !fechaEfecto4Str) { resultadoAlta = "FECHAS INSUFICIENTES"; break; }
                var fechaEfecto3 = new Date(fechaEfecto3Str + 'T00:00:00');
                var fechaEfecto4 = new Date(fechaEfecto4Str + 'T00:00:00');
                if (isNaN(fechaEfecto3.getTime()) || isNaN(fechaEfecto4.getTime())) { resultadoAlta = "FECHAS INSUFICIENTES"; break; }
                var diferenciaMeses = getDateDiffInMonths(fechaEfecto3, fechaEfecto4);
                switch (motivoTramiteText) {
                    case "LIC. PREPENSIONARIA": case "PREJUBILATORIO": resultadoAlta = diferenciaMeses < 6 ? "ALTA EN PENSION" : "ALTA PROVISIONAL"; break;
                    case "BECA COMISIÓN": case "PRORROGA DE BECA COMISION": resultadoAlta = diferenciaMeses < 6 ? "SUSTITUTO BECARIO" : "ALTA PROVISIONAL"; break;
                    case "BAJA POR DEFUNCIÓN": case "LIC. POR ASUNTOS PARTICULARES": case "LIC. POR COM. SINDICAL": case "PRORROGA DE LIC. POR COM. SINDICAL": resultadoAlta = diferenciaMeses < 6 ? "ALTA INTERINA LIMITADA" : "ALTA PROVISIONAL"; break;
                    case "JUBILACIÓN": resultadoAlta = diferenciaMeses < 6 ? "ALTA INTERINA LIMITADA EN VACANTE DEFINITIVA" : "ALTA PROVISIONAL EN VACANTE DEFINITIVA"; break;
                    default: resultadoAlta = "NO PROCEDENTE";
                }
        }
        $('#id_tipo_movimiento_interino').val(resultadoAlta);
    }

    function cargarPrelacionAutomatica(curpInterino) {
        if (!curpInterino) { $('#id_no_prel_display, #id_folio_prel_display, #id_tipo_val_display').val(''); return; }
        $.get('{% url "get_prelacion_data_ajax" %}', { curp_interino: curpInterino }, function(data) {
            $('#id_no_prel_display').val(data.encontrado ? data.numero_prelacion : '');
            $('#id_folio_prel_display').val(data.encontrado ? data.folio_prelacion : '');
            $('#id_tipo_val_display').val(data.encontrado ? data.tipo_val : '');
        }).fail(function() { console.error('Error al cargar datos de prelación'); $('#id_no_prel_display, #id_folio_prel_display, #id_tipo_val_display').val(''); });
    }

    $('#id_plantilla').on('change', function() {
        var plantillaId = $(this).val();
        var motivoTramiteSelect = $('#id_motivo_tramite');
        
        // --- LÓGICA DE VISIBILIDAD DEL MOTIVO ---
        if (plantillaId) { motivoTramiteWrapper.show(); } else { motivoTramiteWrapper.hide(); }

        updateFormVisibility();
        motivoTramiteSelect.empty().append(new Option('', '', true, true)).trigger('change');

        if (plantillaId) {
            $.ajax({ url: '{% url "get_motivos_tramite_ajax" %}', data: { 'plantilla_id': plantillaId }, dataType: 'json',
                success: function(data) {
                    $.each(data, function(key, value) { motivoTramiteSelect.append(new Option(value.text, value.id)); });
                    motivoTramiteSelect.trigger('change');
                }
            });
        }
    });

    function getMaestroData(maestroId, prefix) {
        if (!maestroId) { limpiarCamposMaestro(prefix); return; }
        $.ajax({ url: '{% url "get_maestro_data" %}', data: { 'maestro_id': maestroId }, dataType: 'json',
            success: function(data) {
                if (data.error) { console.error('Error:', data.error); limpiarCamposMaestro(prefix); return; }
                if (prefix === 'titular') {
                    $('#id_curp_titular_display').val(data.curp); $('#id_rfc_titular_display').val(data.rfc);
                    $('#id_clave_presupuestal_titular_display').val(data.clave_presupuestal); $('#id_categoria_titular_display').val(data.categoria);
                    $('#id_funcion_titular_display').val(data.funcion);
                    var interinoId = $('#id_maestro_interino').val();
                    if (interinoId) { getMaestroData(interinoId, 'interino'); }
                } else if (prefix === 'interino') {
                    $('#id_curp_interino_display').val(data.curp); $('#id_rfc_interino_display').val(data.rfc);
                    var presupuestal_titular = $('#id_clave_presupuestal_titular_display').val();
                    var motivo_tramite_text = $('#id_motivo_tramite option:selected').text().trim().toUpperCase();
                    var calculated_presupuestal_interino = presupuestal_titular;
                    if (presupuestal_titular && presupuestal_titular.length >= 2) {
                        if (motivo_tramite_text === "BECA COMISIÓN" || motivo_tramite_text === "PRORROGA DE BECA COMISION") {
                            calculated_presupuestal_interino = "48" + presupuestal_titular.substring(2);
                        } else if (motivo_tramite_text === "LIC. DE GRAVIDEZ") {
                            calculated_presupuestal_interino = "14" + presupuestal_titular.substring(2);
                        } else if (motivo_tramite_text === "LIC. PREPENSIONARIA" || motivo_tramite_text === "PREJUBILATORIO") {
                            calculated_presupuestal_interino = "15" + presupuestal_titular.substring(2);
                        }
                    }
                    $('#id_clave_presupuestal_interino_display').val(calculated_presupuestal_interino);
                    $('#id_funcion_interino_display').val($('#id_funcion_titular_display').val());
                    cargarPrelacionAutomatica(data.curp);
                }
            },
            error: function() { console.error('Error AJAX'); limpiarCamposMaestro(prefix); }
        });
    }

    function limpiarCamposMaestro(prefix) {
        if (prefix === 'titular') {
            $('#id_curp_titular_display, #id_rfc_titular_display, #id_clave_presupuestal_titular_display, #id_categoria_titular_display, #id_funcion_titular_display, #id_clave_presupuestal_interino_display, #id_funcion_interino_display').val('');
        } else if (prefix === 'interino') {
            $('#id_curp_interino_display, #id_rfc_interino_display, #id_clave_presupuestal_interino_display, #id_funcion_interino_display').val('');
            cargarPrelacionAutomatica('');
        }
    }

    // --- NUEVA LÓGICA PARA LIMPIAR FORMULARIO TRAS ÉXITO ---
    $('form').on('submit', function(e) {
        // Usamos un timeout para permitir que la descarga inicie y que los errores de validación (si los hay) aparezcan.
        setTimeout(() => {
            // Si no hay alertas de error de Django, asumimos que fue exitoso.
            if ($('.alert-danger').length === 0) {
                // 1. Crear y mostrar mensaje de éxito
                const successAlert = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        Trámite generado y descargado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                $('.card-body').prepend(successAlert);

                // 2. Limpiar todos los campos del formulario
                $(this)[0].reset();

                // 3. Resetear los campos Select2
                $('#id_plantilla, #id_motivo_tramite, #id_maestro_titular, #id_maestro_interino').val(null).trigger('change');

                // 4. Forzar la actualización de la visibilidad para ocultar todo
                // El .trigger('change') en #id_plantilla ya se encarga de esto.
            }
        }, 1000); // 1 segundo de espera
    });

    // Event listeners
    $('#id_maestro_titular').on('change', function() { getMaestroData($(this).val(), 'titular'); });
    $('#id_maestro_interino').on('change', function() { getMaestroData($(this).val(), 'interino'); });
    $('#id_motivo_tramite').on('change', function() {
        var interinoId = $('#id_maestro_interino').val();
        if (interinoId) { getMaestroData(interinoId, 'interino'); }
        calculateTipoMovimientoInterino();
    });
    $('#id_fecha_efecto3, #id_fecha_efecto4').on('change', function() { calculateTipoMovimientoInterino(); });

    // Cargar datos y visibilidad iniciales
    updateFormVisibility();
    $('#id_maestro_titular').trigger('change');
    $('#id_maestro_interino').trigger('change');
    calculateTipoMovimientoInterino();
});
</script>
{% endblock %}