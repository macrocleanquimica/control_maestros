{% extends 'gestion_escolar/base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Título de la página -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ titulo }}</h1>
    </div>

    <!-- Formulario para agregar vacancia -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Agregar Nueva Vacancia al Lote #{{ lote.id }}</h6>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                <div class="row">
                    <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_maestro_titular" class="form-label">Maestro Titular:</label>
                        <select name="maestro_titular" id="id_maestro_titular" class="form-control" style="width: 100%;"></select>
                        {% if form.maestro_titular.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.maestro_titular.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_clave_presupuestal_display" class="form-label">Clave Presupuestal Titular</label>
                        {{ form.clave_presupuestal_display }}
                    </div>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_maestro_interino" class="form-label">Maestro Interino (Opcional):</label>
                        <select name="maestro_interino" id="id_maestro_interino" class="form-control" style="width: 100%;"></select>
                        {% if form.maestro_interino.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.maestro_interino.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_curp_interino_display" class="form-label">CURP Interino</label>
                        {{ form.curp_interino_display }}
                    </div>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_folio_prelacion_display" class="form-label">Folio de Prelación</label>
                        {{ form.folio_prelacion_display }}
                    </div>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_posicion_orden_display" class="form-label">Posición de Orden</label>
                        {{ form.posicion_orden_display }}
                    </div>
                    
                    <!-- CORRECCIÓN: Condición completa para excluir campos -->
                    {% for field in form %}
                        {% if field.name != 'maestro_titular' and field.name != 'clave_presupuestal_display' and field.name != 'maestro_interino' and field.name != 'curp_interino_display' and field.name != 'folio_prelacion_display' and field.name != 'posicion_orden_display' %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ field.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                </div>
                <div class="d-flex align-items-center mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Agregar al Lote
                    </button>
                    <div class="form-check ms-3">
                        <input class="form-check-input" type="checkbox" id="limpiarFormulario" checked>
                        <label class="form-check-label" for="limpiarFormulario">Limpiar formulario después de agregar</label>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if vacancias_en_lote.exists %}
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Exportar Lote</h5>
        </div>
        <div class="card-body">
            <p>El lote actual tiene <strong>{{ vacancias_en_lote.count }}</strong> vacancia(s) listas para exportar.</p>
            
            <button type="button" class="btn btn-success btn-lg" onclick="confirmExport({{ lote.id }})">
    <i class="fas fa-file-export"></i> Exportar Lote Completo
</button>
            
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Al exportar se generará: 
                    <ul class="mb-0 mt-1">
                        <li>Archivo Excel con todas las vacancias</li>
                        <li>Oficios Word para cada interino</li>
                        <li>Envío automático a Google Sheets</li>
                    </ul>
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de vacancias en el lote actual -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Vacancias en el Lote Actual ({{ vacancias_en_lote.count }} registradas)</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Maestro Titular</th>
                            <th>Categoría</th>
                            <th>Apreciación</th>
                            <th>Fechas</th>
                            <th>Tipo Movimiento</th>
                            <th>Maestro Interino</th>
                            <th>CURP Interino</th>
                            <th>Folio Prelación</th>
                            <th>Posición Orden</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vacancia in vacancias_en_lote %}
                        <tr id="vacancia-{{ vacancia.id }}">
                            <!-- CORRECCIÓN: Verificar si el campo categog existe -->
                            <td>{{ vacancia.maestro_titular }}</td>
                            <td>{{ vacancia.maestro_titular.categoria|default:vacancia.maestro_titular.categog|default:"N/A" }}</td>
                            <td>{{ vacancia.apreciacion.descripcion|truncatechars:50 }}</td>
                            <td>{{ vacancia.fecha_inicio|date:"d/m/Y" }} - {{ vacancia.fecha_final|date:"d/m/Y" }}</td>
                            <td>{{ vacancia.tipo_movimiento_original }}</td>
                            <td>{% if vacancia.maestro_interino %}{{ vacancia.maestro_interino }}{% else %}{{ vacancia.nombre_interino|default:"N/A" }}{% endif %}</td>
                            <td>{% if vacancia.maestro_interino %}{{ vacancia.maestro_interino.curp }}{% else %}{{ vacancia.curp_interino|default:"N/A" }}{% endif %}</td>
                            <td>{{ vacancia.folio_prelacion|default:"N/A" }}</td>
                            <td>{{ vacancia.posicion_orden|default:"N/A" }}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm eliminar-vacancia" data-id="{{ vacancia.id }}">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center">Aún no hay vacancias en este lote.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<!-- Modal de Loading -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
                <p id="loading-message" class="mt-3">Iniciando proceso...</p>
                <div id="final-links" class="mt-3" style="display: none;">
                    <!-- Los enlaces de descarga se agregarán aquí -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<style>
.select2-container--default .select2-selection--single {
    height: 38px;
    padding: 6px 12px;
    border: 1px solid #d1d3e2;
    border-radius: 0.35rem;
}
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}
</style>
{% block extra_js %}
<script>
function showSuccessMessage(message) {
    const alertDiv = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
        '<strong>¡Éxito!</strong> ' + message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
        '</div>');
    $('.container').prepend(alertDiv);
    setTimeout(function() {
        alertDiv.alert('close');
    }, 5000);
}

function confirmExport(loteId) {
    if (confirm('¿Está seguro de que desea procesar y finalizar este lote?\n\nEsta acción generará un archivo Excel con todas las vacancias, documentos Word para las vacancias de corta duración con interino, y enviará datos a Google Sheets. Una vez procesado, el lote no podrá ser modificado.')) {
        iniciarProcesoExportacion(loteId);
    } else {
        console.log('Exportación de lote cancelada por el usuario.');
    }
}

function updateLoadingMessage(message) {
    $('#loading-message').html(message);
}

function iniciarProcesoExportacion(loteId) {
    const csrfToken = $('[name=csrfmiddlewaretoken]').val();
    $('#loadingModal').modal({backdrop: 'static', keyboard: false}); // Evitar que se cierre
    $('#loadingModal').modal('show');
    $('#final-links').hide().empty();

    // --- PASO 1: Generar Documentos Word ---
    updateLoadingMessage('<i class="fas fa-cog fa-spin"></i> Paso 1 de 3: Generando documentos Word...');
    $.ajax({
        url: `/vacancias/exportar/paso_word/${loteId}/`,
        type: 'POST',
        data: { 'csrfmiddlewaretoken': csrfToken },
        success: function(responseWord) {
            if (responseWord.status === 'success' || responseWord.status === 'warning') {
                updateLoadingMessage('<i class="fas fa-check-circle text-success"></i> Paso 1 completado. ' + responseWord.message);
                
                // Guardar los documentos Word para el final
                const wordDocs = responseWord.word_docs || [];

                // --- PASO 2: Enviar a Google Sheets ---
                setTimeout(function() {
                    updateLoadingMessage('<i class="fas fa-cog fa-spin"></i> Paso 2 de 3: Enviando datos a Google Sheets...');
                    $.ajax({
                        url: `/vacancias/exportar/paso_gsheets/${loteId}/`,
                        type: 'POST',
                        data: { 'csrfmiddlewaretoken': csrfToken },
                        success: function(responseGSheets) {
                            if (responseGSheets.status === 'success') {
                                // Si hubo errores en GSheets, los mostramos como advertencia pero continuamos
                                if (responseGSheets.gsheets_errors && responseGSheets.gsheets_errors.length > 0) {
                                    let errorHtml = '<div class="alert alert-warning mt-2"><strong>Advertencia en Google Sheets:</strong><ul class="mb-0 small">';
                                    responseGSheets.gsheets_errors.forEach(function(error) {
                                        errorHtml += `<li>${error}</li>`;
                                    });
                                    errorHtml += '</ul></div>';
                                    $('#loading-message').append(errorHtml);
                                }
                                updateLoadingMessage('<i class="fas fa-check-circle text-success"></i> Paso 2 completado. ' + responseGSheets.message);

                                // --- PASO 3: Generar Excel y finalizar ---
                                setTimeout(function() {
                                    updateLoadingMessage('<i class="fas fa-cog fa-spin"></i> Paso 3 de 3: Creando archivo Excel consolidado...');
                                    $.ajax({
                                        url: `/vacancias/exportar/paso_excel/${loteId}/`,
                                        type: 'POST',
                                        data: { 'csrfmiddlewaretoken': csrfToken },
                                        success: function(responseExcel) {
                                            if (responseExcel.status === 'success') {
                                                updateLoadingMessage('<i class="fas fa-star text-warning"></i> ¡Proceso completado con éxito!');
                                                
                                                // Mostrar enlaces de descarga
                                                let finalLinksHtml = '<h5>Descargas:</h5>';
                                                finalLinksHtml += `<p><a href="${responseExcel.excel_url}" target="_blank" class="btn btn-success"><i class="fas fa-file-excel"></i> Descargar Reporte Excel</a></p>`;
                                                
                                                if (wordDocs.length > 0) {
                                                    finalLinksHtml += '<h6>Documentos Word Generados:</h6><ul class="list-group">';
                                                    wordDocs.forEach(function(doc) {
                                                        finalLinksHtml += `<li class="list-group-item"><a href="${doc.url}" target="_blank">${doc.nombre}</a></li>`;
                                                    });
                                                    finalLinksHtml += '</ul>';
                                                }

                                                $('#final-links').html(finalLinksHtml).show();
                                                
                                                // No recargar la página automáticamente. El usuario cerrará el modal manualmente.
                                                updateLoadingMessage('<i class="fas fa-star text-warning"></i> ¡Proceso completado con éxito! Puede cerrar esta ventana cuando termine.');
                                                
                                                // Añadir un botón de cierre manual
                                                const closeButton = '<button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal" onclick="location.reload()">Cerrar y Recargar</button>';
                                                $('#final-links').append(closeButton);
                                            } else {
                                                handleExportError('Paso 3 (Excel)', responseExcel.message);
                                            }
                                        },
                                        error: function(xhr) { handleExportError('Paso 3 (Excel)', xhr.responseJSON ? xhr.responseJSON.message : 'Error de servidor.'); }
                                    });
                                }, 1500);
                            } else {
                                handleExportError('Paso 2 (Google Sheets)', responseGSheets.message);
                            }
                        },
                        error: function(xhr) { handleExportError('Paso 2 (Google Sheets)', xhr.responseJSON ? xhr.responseJSON.message : 'Error de servidor.'); }
                    });
                }, 1500);
            } else {
                handleExportError('Paso 1 (Word)', responseWord.message);
            }
        },
        error: function(xhr) { handleExportError('Paso 1 (Word)', xhr.responseJSON ? xhr.responseJSON.message : 'Error de servidor.'); }
    });
}

function handleExportError(step, message) {
    updateLoadingMessage(`<i class="fas fa-times-circle text-danger"></i> Error en ${step}: ${message}. El lote no ha sido finalizado. Por favor, intente de nuevo.`);
    // Permitir cerrar el modal en caso de error
    $('#loadingModal').modal({backdrop: true, keyboard: true});
}

function showErrorMessage(message) {
    const alertDiv = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
        '<strong>Error:</strong> ' + message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
        '</div>');
    $('.container').prepend(alertDiv);
    setTimeout(function() {
        alertDiv.alert('close');
    }, 5000);
}

function eliminarVacancia(vacanciaId) {
    if (confirm('¿Estás seguro de que quieres eliminar esta vacancia del lote?')) {
        fetch("{% url 'eliminar_vacancia_lote' 0 %}".replace('0', vacanciaId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error al eliminar la vacancia: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al eliminar la vacancia');
        });
    }
}

// Funciones para búsqueda de maestros y carga de datos
function setupMaestroSelect2(selector, placeholder) {
    $(selector).select2({
        placeholder: placeholder,
        allowClear: true,
        width: '100%',
        ajax: {
            url: "{% url 'buscar_maestros_ajax' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term
                };
            },
            processResults: function (data) {
                // Asegurar que data.results existe
                if (data.results) {
                    return {
                        results: data.results
                    };
                } else {
                    console.error('Formato de respuesta inesperado:', data);
                    return {
                        results: []
                    };
                }
            },
            cache: true
        },
        minimumInputLength: 2,
        language: {
            inputTooShort: function () {
                return 'Ingresa al menos 2 caracteres';
            },
            noResults: function () {
                return 'No se encontraron resultados';
            },
            searching: function () {
                return 'Buscando...';
            }
        }
    });
}

function getMaestroData(maestroId, prefix) {
    if (!maestroId) { limpiarCamposMaestro(prefix); return; }
    $.ajax({
        url: "{% url 'get_maestro_data_for_vacancia' %}", // Usar la URL específica para vacancias
        data: { 'maestro_id': maestroId },
        dataType: 'json',
        success: function(data) {
            if (data.error) { console.error('Error:', data.error); limpiarCamposMaestro(prefix); return; }
            if (prefix === 'titular') {
                $('#id_clave_presupuestal_display').val(data.clave_presupuestal);
            } else if (prefix === 'interino') {
                // Para el interino, necesitamos la CURP para la prelación
                $('#id_curp_interino_display').val(data.curp);
                cargarPrelacionAutomatica(maestroId); // Pasar maestroId para obtener datos de prelación
            }
        },
        error: function() { console.error('Error AJAX al obtener datos del maestro'); limpiarCamposMaestro(prefix); }
    });
}

function cargarPrelacionAutomatica(maestroId) {
    if (!maestroId) { $('#id_posicion_orden_display, #id_folio_prelacion_display').val(''); return; }
    $.ajax({
        url: "{% url 'get_interino_and_prelacion_data_ajax' %}", // Usar la URL específica
        data: { 'maestro_id': maestroId },
        dataType: 'json',
        success: function(data) {
            if (data.error) { console.error('Error:', data.error); $('#id_posicion_orden_display, #id_folio_prelacion_display').val(''); return; }
            $('#id_posicion_orden_display').val(data.posicion_orden);
            $('#id_folio_prelacion_display').val(data.folio_prelacion);
        },
        error: function() { console.error('Error al cargar datos de prelación'); $('#id_posicion_orden_display, #id_folio_prelacion_display').val(''); }
    });
}

function limpiarCamposMaestro(prefix) {
    if (prefix === 'titular') {
        $('#id_clave_presupuestal_display').val('');
    } else if (prefix === 'interino') {
        $('#id_curp_interino_display').val('');
        $('#id_posicion_orden_display').val('');
        $('#id_folio_prelacion_display').val('');
    }
}

function limpiarFormularioCompleto() {
    // Resetea el formulario completo
    $('form[method="post"]')[0].reset();
    // Limpia los campos de Select2
    $('#id_maestro_titular, #id_maestro_interino').val(null).trigger('change');
}


$(document).ready(function() {
    // Verificar que Select2 esté disponible
    if (typeof $.fn.select2 !== 'undefined') {
        console.log('Select2 está disponible');
        
        setupMaestroSelect2('#id_maestro_titular', 'Busca y selecciona un maestro titular');
        setupMaestroSelect2('#id_maestro_interino', 'Busca y selecciona un maestro interino');

        // Event listeners
        $('#id_maestro_titular').on('change', function() {
            getMaestroData($(this).val(), 'titular');
        });

        $('#id_maestro_interino').on('change', function() {
            getMaestroData($(this).val(), 'interino');
        });
    } else {
        console.error('Select2 no está disponible');
        // Fallback: convertir los selects en normales
        $('#id_maestro_titular, #id_maestro_interino').addClass('form-control');
    }
});

// Limpiar el formulario si el checkbox está marcado y la página se recargó con un mensaje de éxito
document.addEventListener('DOMContentLoaded', function() {
    const tieneMensajeExito = document.querySelector('.alert-success');
    if (tieneMensajeExito && localStorage.getItem('limpiarFormulario') === 'true') {
        limpiarFormularioCompleto();
    }
    // Guardar el estado del checkbox para la próxima recarga
    $('#limpiarFormulario').on('change', function() {
        localStorage.setItem('limpiarFormulario', $(this).is(':checked'));
    });
    // Establecer el estado inicial del checkbox desde localStorage
    if (localStorage.getItem('limpiarFormulario') === null || localStorage.getItem('limpiarFormulario') === 'true') {
        $('#limpiarFormulario').prop('checked', true);
    } else {
        $('#limpiarFormulario').prop('checked', false);
    }
});
</script>
{% endblock extra_js %}